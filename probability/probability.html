<html>
  <head>
    <style>
        body {
            font-family: arial, sans-serif;
        }
        h1 {
            color: #606060;
        }
        #canvas {
            border: solid 3px #808080;
        }
        #explain {
            font-size: 300%;
        }
        .missed {
            color: #a0a0a0;
        }
        .hit {
            font-weight: bold;
        }
        .wrap {
            text-align: center;
        }
        .panel {
            position: absolute;
            top: 0;
            right: 0;
            margin: 6px;
        }
        .controls {
            text-align: left;
            margin-left: 5%;
            margin-top: 8px;
        }
        .controls button {
            font-size: 150%;
        }
        button.selected {
            font-weight: bold;
        }
        #explain {
            margin-top: 8px;
            margin-left: 12px;
            margin-right: 5%;
            float: right;
        }
        #intro {
            cursor: pointer;
            font-size: 125%;
        }
        #intro .screen {
            opacity: 0.8;
            background-color: #808080;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }
        #intro .content {
            border: solid 2px green;
            background-color: #e0e8e0;
            padding: 50px;
            position: absolute;
            top: 20px;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 11;
        }
        .big {
            text-align: right;
            font-size: 200%;
            color: green;
        }
    </style>
    <script>
    function app() {
        let canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth * 0.9;
        canvas.height = window.innerHeight * 0.8;
        let ctx = canvas.getContext('2d');

        function choose_grid(squares) {
            let sq = Math.sqrt(squares);
            let r = Math.sqrt(canvas.width / canvas.height);
            let x0 = Math.round(sq * r);
            let best = null;
            const deltas = [0, 1, -1, 2, -2];
            for (let nd=0; nd < deltas.length; nd++) {
                let nx = x0 + deltas[nd];
                if (nx < 1)
                    continue;
                let ny = Math.round(squares / nx);
                let score = -Math.abs(nx*ny - squares);
                if (! best  ||  score > best[0]) {
                    best = [score, nx, ny];
                }
            }
            return [best[1], best[2]];
        }

        function randomize(arr) {
            for (let n=0; n < arr.length; n++) {
                let m = Math.floor(Math.random() * arr.length);
                let a = arr[n];
                let b = arr[m];
                arr[n] = b;
                arr[m] = a;
            }
        }

        function format_pct(v) {
            if (v > 0.30)
                return "" + Math.round(v*100) + "%";
            if (v > 0.03)
                return "" + (v*100).toFixed(1) + "%";
            if (v > 0.003)
                return "" + (v*100).toFixed(2) + "%";
            if (v > 0.0003)
                return "" + (v*100).toFixed(3) + "%";
            return "" + (v*100) + "%";
        }

        function format_prob(v) {
            v = 1 / v;
            if (v >= 10)
                return "1:" + Math.round(v);
            if (v >= 1)
                return "1:" + v.toFixed(1);
            if (v > 0.1)
                return "1:" + v.toFixed(2);
            return "1:" + v;
        }

        class Target {
            constructor(area, events) {
                // determine number of squares needed
                let nsq = 1;
                for (let ne=0; ne < events.length; ne++) {
                    let nsq2 = 1;
                    for (let n=0; n < events[ne].probs.length; n++)
                        nsq2 /= events[ne].probs[n];
                    if (nsq2 > nsq)
                        nsq = nsq2
                }
                if (nsq < 2)
                    nsq = 2;
                while (nsq < 16)
                    nsq *= 2;
                // compute total nested probability
                this.area = area;
                this.grid = choose_grid(nsq);
                this.events = events;
                this.squares = this.grid[0] * this.grid[1];
                this.content = [];
                this.colors = [];
                this.content_index = [];
                // generate content
                for (let ne=0; ne < events.length; ne++) {
                    let event = events[ne];
                    // calculate squares per possibility level
                    let prob = 1;
                    let count_per_level = [];
                    let evt_base = this.content_index.length;
                    for (let n=0; n < event.probs.length; n++) {
                        prob *= event.probs[n];
                        count_per_level.push(Math.round(this.squares * prob));
                        this.content_index.push({event: event, index: n})
                    }
                    // subtract sub-possibility squares
                    for (let n=0; n < count_per_level.length-1; n++) {
                        let n_r = 0;
                        for (let m=n+1; m < count_per_level.length; m++) {
                            n_r += count_per_level[m];
                        }
                        count_per_level[n] -= n_r;
                    }
                    // generate content
                    for (let n=0; n < count_per_level.length; n++) {
                        for (let m=0; m < count_per_level[n]; m++) {
                            this.content.push(evt_base+n)
                        }
                    }
                }
                for (let n=this.content.length; n < this.squares; n++) {
                    this.content.push(-1);
                }
                // randomize
                randomize(this.content);
            }
            square_pos(x, y) {
                return [
                    this.area[0] + x * this.area[2]/this.grid[0],
                    this.area[1] + y * this.area[3]/this.grid[1],
                    this.area[2]/this.grid[0],
                    this.area[3]/this.grid[1]
                ]
            }
            square_content(x, y) {
                let n = this.content[y*this.grid[0] + x];
                if (n >= 0)
                    return this.content_index[n];
                return null;
            }
            draw(selected=null) {
                ctx.fillStyle = "white";
                let lw0 = 0.5;
                if (this.grid[0] > 50)
                    lw0 = 0.2;
                if (this.grid[0] > 100)
                    lw0 = 0.1;
                ctx.fillRect(this.area[0], this.area[1], this.area[2], this.area[3]);
                for (let x=0; x < this.grid[0]; x++) {
                    for (let y=0; y < this.grid[1]; y++) {
                        let content = this.square_content(x, y);
                        let pos = this.square_pos(x, y);
                        let is_sel = selected === y*this.grid[0] + x;
                        let lw = is_sel ? 2 : lw0;
                        ctx.beginPath();
                        ctx.rect(pos[0] + lw/2, pos[1] + lw/2, pos[2] - lw, pos[3] - lw);
                        if (content) {
                            ctx.fillStyle = content.event.colors[content.index];
                            ctx.fill();
                        }
                        ctx.strokeStyle = is_sel ? "black" : "#c0c0c0";
                        ctx.lineWidth = lw
                        ctx.stroke();
                    }
                }
            }
            random_square() {
                return Math.floor(Math.random()*this.squares);
            }
        }

        function describe_event(event) {
            let title = "";
            for (let n=0; n < event.names.length; n++) {
                if (n > 0)
                    title += ", then "
                title += "<span style='color: " + event.colors[n] + "'>";
                title += event.names[n] + " (" + format_prob(event.probs[n]) + ")";
                title += "</span>";
            }
            return title;
        }

        let c = [canvas.width/2, canvas.height/2];
        let target = null;

        function set_scenario(heading, events) {
            target = new Target([c[0] - canvas.width/2, c[1] - canvas.height/2, canvas.width, canvas.height], events);
            let title = heading + ": probability of ";
            for (let ne=0; ne < events.length; ne++) {
                if (ne)
                    title += "<br/>or "
                title += describe_event(events[ne]);
            }
            document.getElementById("title").innerHTML = title;
            target.draw();
        }

        function set_year_scenario(range, p1, p2) {
            let events = [
                {names: ["dying of covid"], probs: [p2], colors: ["#b02020"]},
                {names: ["dying of some other cause"], probs: [p1 - p2], colors: ["#ffa050"]}
            ]
            set_scenario("This year, for someone age " + range, events);
        }

        document.getElementById("s1").addEventListener("click", function(){
            set_year_scenario("0-18", 1/2370, 1/159823);
        });
        document.getElementById("s2").addEventListener("click", function(){
            set_year_scenario("18-30", 1/888, 1/16286);
        });
        document.getElementById("s3").addEventListener("click", function(){
            set_year_scenario("30-40", 1/480, 1/4481);
        });
        document.getElementById("s4").addEventListener("click", function(){
            set_year_scenario("40-50", 1/293, 1/1760);
        });
        document.getElementById("s5").addEventListener("click", function(){
            set_year_scenario("50-65", 1/116, 1/695);
        });
        document.getElementById("s6").addEventListener("click", function(){
            set_year_scenario("65-75", 1/48.7, 1/318);
        });
        document.getElementById("s7").addEventListener("click", function(){
            set_year_scenario("75-85", 1/21.5, 1/161);
        });
        document.getElementById("s8").addEventListener("click", function(){
            set_year_scenario("85+", 1/7.78, 1/76.2);
        });

        let intro = document.getElementById("intro");
        intro.addEventListener("click", function(){
            intro.style.display = "none";
        });

        document.getElementById("try_1").addEventListener("click", function(){
            choose_one();
        });
        document.getElementById("try_n").addEventListener("click", function(evt){
            evt.target.className = (evt.target.className === "selected") ? "" : "selected";
            if (evt.target.className === "selected")
                choose_n();
        });
        document.getElementById("instructions").addEventListener("click", function(){
            intro.style.display = "block";
        });

        set_year_scenario("40-50", 1/317, 1/1903);

        function choose_one() {
            let choice = target.random_square();
            target.draw(choice);
            let expl = document.getElementById("explain");
            let content = target.content[choice];
            if (content < 0) {
                expl.innerHTML = "<span class='missed'>MISSED</span>";
            } else {
                content = target.content_index[content];
                expl.innerHTML = "<span class='hit' style='color: " + content.event.colors[content.index] +  "'>HIT!!!</span>";
            }
        }

        function choose_n(count=1) {
            let btn = document.getElementById("try_n");
            if (btn.className !== "selected")
                return;
            let choice = target.random_square();
            target.draw(choice);
            let expl = document.getElementById("explain");
            let content = target.content[choice];
            if (content < 0) {
                let delay = 700;
                if (count > 8)
                    delay = 400;
                if (count > 18)
                    delay = 300;
                if (count > 30)
                    delay = 200;
                if (count > 50)
                    delay = 100;
                if (count > 100)
                    delay = 50;
                expl.innerHTML = "<span class='missed'>MISSED</span>";
                setTimeout(function() {
                    choose_n(count+1);
                }, delay);
            } else {
                content = target.content_index[content];
                expl.innerHTML = "<span class='hit' style='color: " + content.event.colors[content.index] +  "'>HIT!!! (in " + count + ((count===1)?" try":" tries") + ")</span>";
                btn.className = "";
            }
        }
    }
    window.addEventListener("load", app);
    </script>
  </head>
  <body>
    <div class="wrap">
        <h1 id="title">Probabilities</h1>
        <canvas id="canvas"></canvas><br/>
        <div id="explain">
            ---
        </div>
        <div class="controls">
            <button id="try_1">Try once</button>
            <button id="try_n">Try harder</button>
            <button id="instructions">Show instructions again</button>
        </div>
    </div>
    <div class="panel">
      <button id="s8">Age: 85+</button><br/>
      <button id="s7">Age: 75-85</button><br/>
      <button id="s6">Age: 65-75</button><br/>
      <button id="s5">Age: 50-65</button><br/>
      <button id="s4">Age: 40-50</button><br/>
      <button id="s3">Age: 30-40</button><br/>
      <button id="s2">Age: 18-30</button><br/>
      <button id="s1">Age: 0-18</button><br/>
    </div>
    <div id="intro">
        <div class="screen"></div>
        <div class="content">
            <div class="big">
                &lt;CLICK ANYWHERE TO BEGIN&gt;
            </div>
            <h2>COVID PROBABILITY ILLUSTRATOR</h2>
            Probabilities are hard to imagine.  This page attempts to illustrate them and let you interact a little
            to get a feel for them.  This particular example is based on data from 2021 and shows the odds of people
            in different age ranges dying from Covid versus other causes.
            <h3>How to use it</h3>
            <ul>
                <li>Click on different age ranges on the right to see statistics for that sub-population.</li>
                <li>The red dot(s) represent(s) death by Covid and the orange dots represent death by any other cause.</li>
                <li>Death, in this case, technically means the probability of a person having died in the year 2021,
                    but one can imagine it applying to 2022 as well and being a sort of roulette wheel of doom.</li>
                <li>The 'try once' button spins the roulette wheel of doom, i.e. it picks a square at random.</li>
                <li>The 'try harder' button keeps picking squares at random until it hits a colored square.</li>
            </ul>
            <h3>Technical Notes</h3>
            <ul>
                <li>All data is gathered from public sources.  The notebook where the probabilities were derived,
                    and links to those sources is <a href="covid_death_rate.ipynb">here</a>.</li>
                <li>Any errors or misrepresentations on this page are my own unintentional mistakes.</li>
                <li>The grid for 0-18 year olds is extremely dense because of the small probabilities involved, so it
                    doesn't look great and I suggest starting with something else.  If you look hard, though, you
                    will see one very small dark red dot, and a scattering of orange dots.</li>
            </ul>
            <h3>Ethical Notes</h3>
            <ul>
                <li>If learning more about statistics makes public policy or a person's behavior better, then
                woo hoo!!!</li>
                <li>If learning more about statistics makes public policy or a person's behavior worse, then I
                sincerely apologize and beg forgiveness.</li>
                <li>I also apologize if you do not share my unrefined sense of humor about the idea of a 'roulette wheel of doom'.</li>
            </ul>
        </div>
    </div>
  </body>
<!--
  TODO
    update probs
    pop-up with explanation
    link with JSON spec
    small browser size - smaller canvas
    oversample for high probabilities (like 0.83)
    warn on invalid probs
-->
</html>